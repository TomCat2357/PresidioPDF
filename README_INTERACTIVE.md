# PDF インタラクティブ編集機能

PDFのハイライトをクリックして範囲を伸ばしたり縮めたりできるインタラクティブ編集機能を実装しました。

## 新機能の概要

### 1. インタラクティブPDF編集エンジン (`src/interactive_pdf_editor.py`)

- **ハイライトクリック検出**: PDF上のハイライトをクリックして選択
- **範囲調整機能**: 選択したハイライトの範囲を文字単位で調整
- **リアルタイム更新**: 変更内容をリアルタイムでPDFに反映

#### 調整機能:
- **左端拡張**: ハイライト範囲を左に拡張
- **右端拡張**: ハイライト範囲を右に拡張  
- **左端縮小**: ハイライト範囲を左から縮小
- **右端縮小**: ハイライト範囲を右から縮小

### 2. インタラクティブGUI (`src/pdf_interactive_gui.py`)

- **視覚的な編集インターフェース**: クリック＆ドラッグでハイライト範囲を調整
- **ページナビゲーション**: PDFページの切り替え
- **ズーム機能**: 細かい編集作業のための拡大・縮小
- **ハイライト一覧**: すべてのハイライトを一覧表示
- **リアルタイムプレビュー**: 編集内容をリアルタイムで確認

## 使用方法

### 基本的な使い方

1. **GUIアプリケーションの起動**:
```bash
uv run python test_interactive_edit.py
```

2. **PDFファイルを開く**:
   - "PDFを開く"ボタンをクリック
   - ハイライト付きのPDFファイルを選択

3. **ハイライトの選択**:
   - PDF表示エリアでハイライトをクリック
   - 選択されたハイライトの詳細が右パネルに表示

4. **範囲の調整**:
   - **← 拡張**: 左端を1文字拡張
   - **拡張 →**: 右端を1文字拡張
   - **← 縮小**: 左端を1文字縮小
   - **縮小 →**: 右端を1文字縮小

5. **変更の保存**:
   - "保存"ボタンをクリックして変更をPDFに保存

### プログラムでの使用例

```python
from src.interactive_pdf_editor import InteractivePDFEditor
import fitz

# エディターを作成
with InteractivePDFEditor("document.pdf") as editor:
    # クリック座標でハイライトを選択
    point = fitz.Point(100, 200)
    if editor.select_highlight(0, point):  # ページ0の座標(100,200)
        # 右端を3文字拡張
        editor.adjust_highlight_range("right", 3)
        
        # 左端を1文字縮小
        editor.adjust_highlight_range("shrink_left", 1)
        
        # 変更を保存
        editor.save_changes("modified.pdf")
```

## 技術仕様

### 必要な依存関係
- `PyMuPDF (fitz)`: PDF処理
- `tkinter`: GUI実装
- `PIL (Pillow)`: 画像処理
- `logging`: ログ出力

### サポートされる機能
- **ハイライト検出**: PDF内の既存ハイライトを自動検出
- **座標変換**: GUI座標からPDF座標への変換
- **テキスト範囲計算**: 文字位置から座標への変換
- **注釈更新**: PyMuPDFを使用したハイライト注釈の更新

### パフォーマンス最適化
- **レイジーロード**: 必要なページのみレンダリング
- **キャッシュ機能**: ページ画像をメモリにキャッシュ
- **効率的な座標計算**: 最適化されたテキスト位置計算

## キーボードショートカット

- **Ctrl+O**: PDFファイルを開く
- **Ctrl+S**: 変更を保存
- **←/→**: 前/次のページ
- **Ctrl+=/Ctrl+-**: ズームイン/ズームアウト

## トラブルシューティング

### よくある問題

1. **ハイライトが選択できない**:
   - ハイライトが正しく作成されているか確認
   - クリック座標がハイライト範囲内にあるか確認

2. **範囲調整が動作しない**:
   - ハイライトが選択されているか確認
   - 調整方向と現在の範囲が適切か確認

3. **保存エラー**:
   - ファイルが他のアプリケーションで開かれていないか確認
   - 書き込み権限があるディレクトリか確認

### ログ出力
詳細なログは `interactive_test.log` ファイルに出力されます。

## 今後の拡張予定

- **ドラッグ＆ドロップ**: マウスドラッグでの範囲調整
- **キーボード操作**: 矢印キーでの細かい調整
- **一括編集**: 複数ハイライトの同時編集
- **アンドゥ/リドゥ**: 編集操作の取り消し機能
- **プリセット**: よく使う調整パターンの保存

## API リファレンス

### InteractivePDFEditor クラス

#### メソッド:
- `select_highlight(page_num, point)`: ハイライト選択
- `adjust_highlight_range(direction, amount)`: 範囲調整
- `save_changes(output_path)`: 変更保存
- `get_highlight_at_point(page_num, point)`: 座標からハイライト取得

#### イベント:
- `on_highlight_changed`: ハイライト変更時のコールバック

### PDFInteractiveGUI クラス

#### 主要コンポーネント:
- **PDFビューア**: ズーム、ページネーション対応
- **ハイライト情報パネル**: 選択中のハイライト詳細表示
- **ハイライト一覧**: 全ハイライトのツリービュー
- **編集ツールバー**: 範囲調整ボタン群