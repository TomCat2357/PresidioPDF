# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

# PresidioPDF Project Configuration

## Overview
This project is a **Japanese personal information detection and masking tool for PDF documents** using Microsoft Presidio. Dependencies are managed using **uv**.

## Package Management
- **Package Manager**: `uv` is used for dependency management
- **Add new dependencies**: `uv add <package-name>`
- **Add development dependencies**: `uv add --dev <package-name>`
- **Sync dependencies**: `uv sync`
- **Run commands**: `uv run <command>` or activate virtual environment

## Remark!
- Don't use desktop-commander unless the user specifically requests it.

## Project Structure
```
PresidioPDF/
├── CLAUDE.md              # This file (Claude project configuration)
├── pyproject.toml         # Project configuration and uv dependencies
├── uv.lock               # Lock file (auto-generated by uv)
├── .venv/                # Virtual environment (auto-created by uv)
├── .mcp.json             # MCP server configuration
├── config.yaml           # Application configuration
├── config_ja_core_news_md.yaml  # Japanese NLP model config
├── src/                  # Source code
│   ├── core/             # Core functionality
│   ├── nlp/              # NLP processing modules
│   ├── pdf/              # PDF processing modules
│   ├── web/              # Web application modules
│   ├── templates/        # HTML templates
│   ├── static/           # Static web assets
│   └── outputs/          # Output processing
├── tests/                # Test files
├── test_pdfs/            # Test PDF files
├── data/                 # Data files
├── outputs/              # Generated output files
├── web_uploads/          # Web app upload directory
├── archives/             # Archive files
└── build/                # Build artifacts
```

## Optional Dependencies
The project supports multiple installation modes:
- **Default (CPU)**: Basic functionality with CPU-only models
- **GPU**: Enhanced performance with GPU-optimized models
- **Minimal**: Lightweight installation for basic PDF processing
- **Web**: Web application dependencies
- **GUI**: Desktop GUI dependencies
- **Dev**: Development and testing tools

## Core Architecture

The project implements a modular PDF PII detection and masking system with two main execution modes:

### Entry Points
- **CLI Mode**: `src/cli.py` - Command-line interface with comprehensive options
- **Web Mode**: `src/web_main.py` - Flask web application with GUI

### Core Components
- **PDFProcessor** (`src/pdf_processor.py`): Main orchestrator handling workflow coordination
- **Analyzer** (`src/analyzer.py`): Presidio-based PII detection with Japanese NLP models
- **PDFMasker** (`src/pdf_masker.py`): PyMuPDF-based text masking operations
- **PDFAnnotator** (`src/pdf_annotator.py`): Annotation/highlight management for PDFs
- **PDFTextLocator** (`src/pdf_locator.py`): Text coordinate location within PDF documents
- **ConfigManager** (`src/config_manager.py`): YAML-based configuration with CLI override support

### Processing Modes
1. **Detection & Masking**: Standard PII detection and masking workflow
2. **Read Mode**: Extract existing annotations/highlights from PDFs (`--read-mode`)
3. **Restore Mode**: Restore annotations from saved reports (`--restore-mode`)

### Multi-Model Support
The system supports different spaCy Japanese models via optional dependencies:
- `ja-core-news-sm`: Lightweight model (default/minimal)
- `ja-core-news-md`: Medium accuracy model
- `ja-core-news-lg`: High accuracy model (GPU optional)
- `ja-core-news-trf`: Transformer-based model (highest accuracy, requires transformers)

## Development Workflow
1. **Setup**: `uv sync` to install project dependencies
2. **Development**: Edit code, then run with `uv run <script>`
3. **Testing**: `uv run pytest` for running tests
4. **Linting**: `uv run black .` for code formatting
5. **Type checking**: `uv run mypy src/` for type verification

## Instructions for Claude
- Always use `uv` commands for package management
- Do NOT use `pip` - this project exclusively uses uv
- When adding new dependencies, check `pyproject.toml` for appropriate optional dependency groups
- The virtual environment is automatically created in `.venv/` directory
- Work from the project root directory
- This is a Japanese NLP project focusing on PII detection in PDFs
- The project uses spaCy with Japanese models for text processing
- Web interface is available via Flask application
- **Command availability troubleshooting:**
  - If a command is not found on Windows, use `where <command>` to check location
  - If a command is not found on Linux/Unix, use `which <command>` to check location
  - Note: `uv` may be installed in user-specific paths like `/home/user/.local/bin/uv` (Linux) or `%USERPROFILE%\.local\bin\uv` (Windows)
  - If `uv` is not in PATH, you may need to use the full path or add it to environment variables

## Configuration Management

The application uses YAML configuration files with CLI override support:

### Primary Config Files
- `config/config.yaml`: Main application configuration
- `config/config_template.yaml`: Template for custom configurations

### Key Configuration Sections
- `nlp.spacy_model`: Japanese spaCy model selection
- `pdf_masking_method`: Choose 'annotation', 'highlight', or 'both'
- `entities`: Enable/disable specific PII entity types
- `output_settings`: Control output paths and backup behavior
- `features.logging`: Logging level and output configuration

### Override Priority (highest to lowest)
1. CLI arguments (`--spacy-model`, `--masking-method`, etc.)
2. Custom config file (`--config custom.yaml`)
3. Default config file (`config/config.yaml`)
4. Built-in defaults

## Important Files
- `pyproject.toml`: Project configuration and dependency definitions with optional extras
- `uv.lock`: Dependency lock file (version pinning)
- `config/config.yaml`: Application configuration file
- `src/pdf_presidio_processor.py.old`: Legacy main processor (deprecated)
- `src/web_main.py`: Web application entry point
- `src/cli.py`: Command-line interface entry point
- `src/pdf_processor.py`: Main processing orchestrator

## Common Commands
```bash
# Project initialization
uv sync

# Install optional dependencies
uv sync --extra dev        # Development tools
uv sync --extra gpu        # GPU-optimized models
uv sync --extra web        # Web application
uv sync --extra gui        # Desktop GUI

# Run the CLI application (various modes)
uv run python -m src.cli path/to/file.pdf
uv run python -m src.cli path/to/file.pdf --read-mode
uv run python -m src.cli path/to/file.pdf --restore-mode --report-file report.json
uv run python -m src.cli path/to/file.pdf --config config.yaml --spacy-model ja-core-news-lg

# Run web application
uv run python src/web_main.py
uv run python src/web_main.py --gpu --port 8080

# Testing
uv run pytest                    # Run all tests
uv run pytest tests/test_*.py   # Run specific test files
uv run pytest -v               # Verbose test output
uv run pytest --cov=src       # Run with coverage

# Code quality
uv run black .                  # Format all code
uv run black src/              # Format specific directory
uv run mypy src/               # Type check source code
uv run mypy src/pdf_processor.py  # Type check specific file

# Dependency management
uv tree                        # Show dependency tree
uv sync                        # Sync dependencies
uv sync --extra dev           # Install with dev dependencies
uv sync --extra gpu           # Install with GPU support
uv add package-name           # Add new dependency
uv add --dev pytest-mock      # Add dev dependency

# Environment management
uv shell                       # Enter virtual environment shell
```

## Automated Web Testing

### webui-integration-test
Full web application integration test routine that performs end-to-end testing of the PII detection web interface:

1. **Process Check**: Check if localhost:5000 is running and kill any existing processes
2. **Server Start**: Launch Flask server with `src/web_main.py` on localhost:5000 (run in background or with timeout since server doesn't return control)
3. **Browser Access**: Use Playwright to access localhost:5000
4. **File Upload**: Upload specified PDF file using the upload button
5. **Model Selection**: Select specified spaCy model (defaults to "ja-core-news-sm" if not specified)
6. **Detection**: Click the detection button to process the PDF
7. **Results Save**: Save detected personal information list to `output/` directory with specified filename
8. **Screenshot**: Take page screenshot and save to `output/` directory with same name as results but different extension

This test routine validates the complete web application workflow from file upload to PII detection results.