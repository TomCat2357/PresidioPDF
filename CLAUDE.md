# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

# PresidioPDF Project Configuration

## Overview
This project is a **Japanese personal information detection and masking tool for PDF documents** using Microsoft Presidio. Dependencies are managed using **uv**.

## Package Management
- **Package Manager**: `uv` is used for dependency management
- **Add new dependencies**: `uv add <package-name>`
- **Add development dependencies**: `uv add --dev <package-name>`
- **Sync dependencies**: `uv sync`
- **Run commands**: `uv run <command>` or activate virtual environment

## Remark!
- Don't use desktop-commander unless the user specifically requests it.

## Project Structure
```
PresidioPDF/
â”œâ”€â”€ CLAUDE.md              # This file (Claude project configuration)
â”œâ”€â”€ .claude/               # Claude AI documentation structure
â”‚   â”œâ”€â”€ 00_project/        # Project requirements and overview
â”‚   â”œâ”€â”€ 01_development_docs/ # Technical design documents
â”‚   â”œâ”€â”€ 02_design_system/  # Design system documentation
â”‚   â””â”€â”€ 03_library_docs/   # Library strategies and dependencies
â”œâ”€â”€ pyproject.toml         # Project configuration and uv dependencies
â”œâ”€â”€ uv.lock               # Lock file (auto-generated by uv)
â”œâ”€â”€ .venv/                # Virtual environment (auto-created by uv)
â”œâ”€â”€ .mcp.json             # MCP server configuration
â”œâ”€â”€ config.yaml           # Application configuration
â”œâ”€â”€ config_ja_core_news_md.yaml  # Japanese NLP model config
â”œâ”€â”€ src/                  # Source code
â”‚   â”œâ”€â”€ core/             # Core functionality
â”‚   â”œâ”€â”€ nlp/              # NLP processing modules
â”‚   â”œâ”€â”€ pdf/              # PDF processing modules
â”‚   â”œâ”€â”€ web/              # Web application modules
â”‚   â”œâ”€â”€ templates/        # HTML templates
â”‚   â”œâ”€â”€ static/           # Static web assets
â”‚   â””â”€â”€ outputs/          # Output processing
â”œâ”€â”€ tests/                # Test files
â”œâ”€â”€ test_pdfs/            # Test PDF files
â”œâ”€â”€ data/                 # Data files
â”œâ”€â”€ outputs/              # Generated output files
â”œâ”€â”€ web_uploads/          # Web app upload directory
â”œâ”€â”€ archives/             # Archive files
â””â”€â”€ build/                # Build artifacts
```

## Optional Dependencies
The project supports multiple installation modes:
- **Default (CPU)**: Basic functionality with CPU-only models
- **GPU**: Enhanced performance with GPU-optimized models
- **Minimal**: Lightweight installation for basic PDF processing
- **Web**: Web application dependencies
- **GUI**: Desktop GUI dependencies
- **Dev**: Development and testing tools

## Core Architecture

The project implements a modular PDF PII detection and masking system with two main execution modes:

### Entry Points
- **CLI Mode**: `src/cli.py` - Command-line interface with comprehensive options
- **Web Mode**: `src/web_main.py` - Flask web application with GUI

### Core Components
- **PDFProcessor** (`src/pdf_processor.py`): Main orchestrator handling workflow coordination
- **Analyzer** (`src/analyzer.py`): Presidio-based PII detection with Japanese NLP models
- **PDFMasker** (`src/pdf_masker.py`): PyMuPDF-based text masking operations
- **PDFAnnotator** (`src/pdf_annotator.py`): Annotation/highlight management for PDFs
- **PDFTextLocator** (`src/pdf_locator.py`): Text coordinate location within PDF documents
- **ConfigManager** (`src/config_manager.py`): YAML-based configuration with CLI override support

### Processing Modes
1. **Detection & Masking**: Standard PII detection and masking workflow
2. **Read Mode**: Extract existing annotations/highlights from PDFs (`--read-mode`)
3. **Restore Mode**: Restore annotations from saved reports (`--restore-mode`)

### Multi-Model Support
The system supports different spaCy Japanese models via optional dependencies:
- `ja-core-news-sm`: Lightweight model (default/minimal)
- `ja-core-news-md`: Medium accuracy model
- `ja-core-news-lg`: High accuracy model (GPU optional)
- `ja-core-news-trf`: Transformer-based model (highest accuracy, requires transformers)

## Development Workflow
1. **Setup**: `uv sync` to install project dependencies
2. **Development**: Edit code, then run with `uv run <script>`
3. **Quality Check**: `uv run black . && uv run mypy src/ && uv run pytest --cov=src` for comprehensive quality validation
4. **Testing**: `uv run pytest` for running tests
5. **Linting**: `uv run black .` for code formatting
6. **Type checking**: `uv run mypy src/` for type verification

## Quality Standards
- **Zero Warning Policy**: All warnings are treated as errors and must be fixed
- **Strict Type Safety**: mypy type checking is mandatory, avoid `Any` types
- **Test-Driven Development**: Write tests before implementing features
- **Coverage Requirement**: Maintain 80%+ test coverage

## Instructions for Claude
- Always use `uv` commands for package management
- Do NOT use `pip` - this project exclusively uses uv
- When adding new dependencies, check `pyproject.toml` for appropriate optional dependency groups
- The virtual environment is automatically created in `.venv/` directory
- Work from the project root directory
- This is a Japanese NLP project focusing on PII detection in PDFs
- The project uses spaCy with Japanese models for text processing
- Web interface is available via Flask application
- **Command availability troubleshooting:**
  - If a command is not found on Windows, use `where <command>` to check location
  - If a command is not found on Linux/Unix, use `which <command>` to check location
  - Note: `uv` may be installed in user-specific paths like `/home/user/.local/bin/uv` (Linux) or `%USERPROFILE%\.local\bin\uv` (Windows)
  - If `uv` is not in PATH, you may need to use the full path or add it to environment variables

## Configuration Management

The application uses YAML configuration files with CLI override support:

### Primary Config Files
- `config/config.yaml`: Main application configuration
- `config/config_template.yaml`: Template for custom configurations

### Key Configuration Sections
- `nlp.spacy_model`: Japanese spaCy model selection
- `pdf_masking_method`: Choose 'annotation', 'highlight', or 'both'
- `entities`: Enable/disable specific PII entity types
- `output_settings`: Control output paths and backup behavior
- `features.logging`: Logging level and output configuration

### Override Priority (highest to lowest)
1. CLI arguments (`--spacy-model`, `--masking-method`, etc.)
2. Custom config file (`--config custom.yaml`)
3. Default config file (`config/config.yaml`)
4. Built-in defaults

## Important Files
- `pyproject.toml`: Project configuration and dependency definitions with optional extras
- `uv.lock`: Dependency lock file (version pinning)
- `config/config.yaml`: Application configuration file
- `src/pdf_presidio_processor.py.old`: Legacy main processor (deprecated)
- `src/web_main.py`: Web application entry point
- `src/cli.py`: Command-line interface entry point
- `src/pdf_processor.py`: Main processing orchestrator

## Common Commands
```bash
# Project initialization
uv sync

# Install optional dependencies
uv sync --extra dev        # Development tools
uv sync --extra gpu        # GPU-optimized models
uv sync --extra web        # Web application
uv sync --extra gui        # Desktop GUI

# Run the CLI application (various modes)
uv run python -m src.cli path/to/file.pdf
uv run python -m src.cli path/to/file.pdf --read-mode
uv run python -m src.cli path/to/file.pdf --restore-mode --report-file report.json
uv run python -m src.cli path/to/file.pdf --config config.yaml --spacy-model ja-core-news-lg

# Run web application
uv run python src/web_main.py
uv run python src/web_main.py --gpu --port 8080

# Testing
uv run pytest                    # Run all tests
uv run pytest tests/test_*.py   # Run specific test files
uv run pytest -v               # Verbose test output
uv run pytest --cov=src       # Run with coverage

# Code quality
uv run black .                  # Format all code
uv run black src/              # Format specific directory
uv run mypy src/               # Type check source code
uv run mypy src/pdf_processor.py  # Type check specific file

# Dependency management
uv tree                        # Show dependency tree
uv sync                        # Sync dependencies
uv sync --extra dev           # Install with dev dependencies
uv sync --extra gpu           # Install with GPU support
uv add package-name           # Add new dependency
uv add --dev pytest-mock      # Add dev dependency

# Environment management
uv shell                       # Enter virtual environment shell
```

## Automated Web Testing

### webui-integration-test
Full web application integration test routine that performs end-to-end testing of the PII detection web interface:

1. **Process Check**: Check if localhost:5000 is running and kill any existing processes
2. **Server Start**: Launch Flask server with `src/web_main.py` on localhost:5000 (run in background or with timeout since server doesn't return control)
3. **Browser Access**: Use Playwright to access localhost:5000
4. **File Upload**: Upload specified PDF file using the upload button
5. **Model Selection**: Select specified spaCy model (defaults to "ja-core-news-sm" if not specified)
6. **Detection**: Click the detection button to process the PDF
7. **Results Save**: Save detected personal information list to `output/` directory with specified filename
8. **Screenshot**: Take page screenshot and save to `output/` directory with same name as results but different extension

This test routine validates the complete web application workflow from file upload to PII detection results.

## Comprehensive Documentation Structure

This project includes extensive documentation organized into four main categories:

### ðŸ“‹ Project Documentation (`.claude/00_project/`)
- `01_project_overview.md`: Complete project overview and architecture
- `02_inception_deck.md`: Strategic project vision, users, and success metrics

### ðŸ”§ Development Documentation (`.claude/01_development_docs/`)
- `03_database_design.md`: Data management strategies using YAML/JSON
- `04_api_design.md`: REST API and internal service architecture  
- `05_screen_transition_design.md`: Web UI navigation and flow patterns
- `06_seo_requirements.md`: Search engine optimization strategy
- `07_error_handling_design.md`: Comprehensive error management patterns
- `08_type_definitions.md`: Python type system and Pydantic validation
- `09_development_setup.md`: Development environment configuration guide
- `10_test_strategy.md`: Testing approaches and frameworks
- `11_frontend_design.md`: Flask web UI architecture and patterns
- `12_cicd_design.md`: CI/CD pipeline design with GitHub Actions
- `13_e2e_test_design.md`: End-to-end testing with Playwright
- `14_security_design.md`: Security architecture and threat mitigation
- `15_performance_optimization.md`: Performance tuning strategies
- `16_performance_monitoring.md`: Monitoring and alerting systems

### ðŸŽ¨ Design System Documentation (`.claude/02_design_system/`)
- `00_basic_design.md`: Core design system foundation with CSS variables
- `01_design_principles.md`: Design philosophy and user-centered guidelines
- `02_component_design.md`: Complete UI component library (atoms to templates)
- `03_animation_system.md`: Motion design and animation patterns
- `04_layout_system.md`: Responsive grid and layout systems

### ðŸ“š Library Integration Documentation (`.claude/03_library_docs/`)
- `02_presidio_integration_guide.md`: Microsoft Presidio setup and Japanese PII detection
- `03_spacy_model_testing.md`: spaCy Japanese model comparison and testing strategies
- `04_pymupdf_patterns.md`: PyMuPDF optimization patterns and advanced PDF processing

### ðŸ“– How to Use This Documentation

**For New Team Members:**
1. Start with `00_project/01_project_overview.md` for project understanding
2. Review `00_project/02_inception_deck.md` for strategic context
3. Follow `01_development_docs/09_development_setup.md` for environment setup

**For Development:**
- Consult design system docs before implementing UI components
- Reference library docs for optimal usage patterns
- Follow error handling and type definition guidelines

**For Architecture Decisions:**
- Review security and performance documentation
- Consult API design patterns for new endpoints
- Follow established testing strategies

**Quick Reference Links:**
- [Project Overview](.claude/00_project/01_project_overview.md)
- [Development Setup](.claude/01_development_docs/09_development_setup.md) 
- [Component Library](.claude/02_design_system/02_component_design.md)
- [Presidio Integration](.claude/03_library_docs/02_presidio_integration_guide.md)
- [Testing Strategy](.claude/01_development_docs/10_test_strategy.md)