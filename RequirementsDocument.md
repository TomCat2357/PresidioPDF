# 仕様書：PDF個人情報マスキングツール

## 1. 概要

本プロジェクトは、Python製コマンドラインツール `pdf_presidio_processor.py` をバックエンドとして活用し、直感的なデスクトップGUIアプリケーションをFlutterで開発することを目的とする。利用者はPDFファイルを読み込み、自動で個人情報を検出・ハイライトさせ、その結果を対話的に修正し、マスキング済みのPDFとして保存できる。

## 2. プロジェクト目標

* **直感的なUI/UXの提供**: コマンドライン操作に不慣れなユーザーでも、簡単に個人情報検出とマスキング処理を行えるようにする。
* **対話的な編集機能**: 自動検出された結果（アノテーション）に対し、ユーザーが手動で追加、削除、修正を行える柔軟性を提供する。
* **高度な設定の簡易化**: `pdf_presidio_processor.py` が持つ豊富な設定項目（検出エンティティ、閾値、重複除去など）を、GUIから分かりやすく設定可能にする。
* **堅牢なレポート機能**: 処理結果をJSONまたはCSV形式でエクスポートする機能を実装する。

## 3. 技術スタック

* **フロントエンド**: Flutter (Windows, macOS, Linuxに対応するクロスプラットフォームデスクトップアプリ)
* **バックエンド**: `pdf_presidio_processor.py` (既存のPythonスクリプト)
* **連携方式**:
    * FlutterアプリからPythonスクリプトをサブプロセスとして実行する。
    * データの受け渡しは、標準入出力（stdin/stdout）または一時ファイルを介してJSON形式で行う。これにより、インタラクティブな操作にも対応可能とする。

## 4. 主要機能要件

### 4.1. ファイル管理
* **ファイルを開く**:
    * 単一のPDFファイルを指定して開く。
    * ドラッグ＆ドロップでのファイル読み込みに対応する。
* **名前を付けて保存**:
    * マスキング処理を適用したPDFを、新しい名前で保存する。
    * デフォルトの出力ファイル名は、元のファイル名に `_masked` などの接尾辞を付与したものとする（接尾辞は設定で変更可能）。
* **最近使ったファイル**: アプリケーション起動時に、最近開いたファイルのリストを表示する。

### 4.2. PDF表示画面
* **メインPDFビューア**:
    * 選択されたPDFのページを忠実に表示する。
    * ズームイン/ズームアウト、パン（画面の移動）機能を提供する。
    * 検出された個人情報箇所に、半透明のハイライト（矩形）を重ねて表示する。
* **ページサムネイルパネル**:
    * PDFの全ページをサムネイル表示する。
    * サムネイルクリックで、メインビューアの表示ページが切り替わる。
* **検出結果一覧パネル**:
    * 検出された個人情報（エンティティ）をリスト表示する。
    * リスト項目には、エンティティの種類（例：人名、電話番号）、検出テキスト、信頼度スコア、ページ番号を表示する。
    * リスト項目をクリックすると、メインビューアが該当ページ・該当箇所にジャンプしてフォーカスする。
* **プロパティパネル**:
    * 検出結果一覧で選択されたエンティティの詳細情報を表示・編集する。
    * 表示項目：エンティティタイプ、検出テキスト、信頼度スコア。
    * 編集項目：エンティティタイプの変更（ドロップダウンリストから選択）。

### 4.3. 個人情報検出
* **自動検出**: PDFファイルを開いた後、ユーザーが「検出開始」ボタンを押すことで、バックエンドの`pdf_presidio_processor.py`を呼び出し、個人情報検出処理を実行する。
* **処理中表示**: 検出処理中は、プログレスバーやインジケータを表示し、アプリケーションが動作中であることをユーザーに明示する。
* **検出結果の反映**: 検出処理が完了したら、検出結果一覧パネルとメインPDFビューアに結果を即座に反映させる。

### 4.4. 検出結果のインタラクティブ編集
* **アノテーションの追加**:
    * ユーザーがPDFビューア上で範囲をドラッグして、新しいハイライト（アノテーション）を作成できる。
    * 作成後、プロパティパネルでエンティティタイプを割り当てる。
* **アノテーションの削除**:
    * 検出結果一覧またはPDFビューア上のハイライトを選択し、削除（非表示化）できる。
* **アノテーションの修正**:
    * PDFビューア上で、既存のハイライトの範囲（矩形）をドラッグしてサイズ変更できるようにする。
    * プロパティパネルで、選択したハイライトのエンティティタイプを変更できる。

### 4.5. 設定管理
* **設定画面**: アプリケーション内に設定画面を設け、以下の項目を変更可能にする。
    * [cite_start]**検出対象エンティティ**: `PERSON`, `LOCATION`, `PHONE_NUMBER` などのエンティティタイプを、チェックボックスで有効/無効に切り替えられる [cite: 1019, 1025, 1048]。
    * [cite_start]**信頼度閾値**: 各エンティティタイプに対する信頼度スコアの閾値をスライダー等で設定できる [cite: 1019, 1025]。
    * **マスキング方法**:
        * [cite_start]マスキングの種類を「ハイライト」「注釈（矩形ボックス）」から選択できる [cite: 1050, 1053]。
        * [cite_start]注釈に表示するテキストモードを「詳細(verbose)」「最小限(minimal)」「なし(silent)」から選択できる [cite: 1026, 1028, 1033]。
    * [cite_start]**重複除去**: `deduplication` の設定をGUIから選択可能にする [cite: 1029, 1030]。
        * [cite_start]優先順位: `score`, `wider_range`, `entity_type` [cite: 1030]
        * [cite_start]重複判定モード: `contain_only`, `partial_overlap` [cite: 1029]
    * [cite_start]**使用モデル**: `spacy_model` を選択肢（`ja_core_news_sm`, `ja_core_news_md`, `ja_ginza`等）から選べるようにする [cite: 1006, 1012]。
* **設定の永続化**: ユーザーが変更した設定は、アプリケーション終了後も保持される。

### 4.6. レポート出力
* **エクスポート機能**:
    * メニューバーまたはボタンから「レポートをエクスポート」機能を選択できる。
    * 出力形式として「JSON」「CSV」を選択できるダイアログを表示する。
    * 最終的な検出結果（手動修正後）を、指定した形式でファイルに出力する。

## 5. 画面構成案

```
+---------------------------------------------------------------------------------+
| アプリケーションメニュー (ファイル, 設定, ヘルプ)                               |
+---------------------------------------------------------------------------------+
| ツールバー (開く, 保存, 検出開始, レポート出力, Zoom In/Out)                    |
+----------------------+---------------------------------+------------------------+
|                      |                                 | [検出結果一覧パネル]   |
| [ページサムネイル]   |                                 |------------------------|
|                      |                                 | - 人名: 田中太郎 (P.1) |
| - Page 1             |                                 | - 電話: 03-XXXX.. (P.2)|
| - Page 2             |      [メインPDFビューア]          | - 場所: 東京都.. (P.2) |
| - ...                |                                 |   ...                  |
|                      |   (PDF内容とハイライト表示)       |                        |
|                      |                                 |------------------------|
|                      |                                 | [プロパティパネル]     |
|                      |                                 |------------------------|
|                      |                                 | タイプ: [人名 ▼]     |
|                      |                                 | テキスト: 田中太郎     |
|                      |                                 | 信頼度: 0.85         |
|                      |                                 | [アノテーション削除]   |
+----------------------+---------------------------------+------------------------+
| ステータスバー (ファイル名, ページ番号, 処理状況)                               |
+---------------------------------------------------------------------------------+
```

## 6. 非機能要件
* **パフォーマンス**: 100ページ程度のPDFでも、表示や基本的な操作がストレスなく行えること。個人情報検出処理の時間はバックグラウンドで実行され、UIのフリーズを避けること。
* **UI/UX**: モダンでクリーンなデザインを採用し、全ての機能が3クリック以内でアクセスできることを目指す。
* **対応プラットフォーム**: Windows 10/11, macOS, Linux。
* **エラーハンドリング**: Pythonスクリプトの実行失敗、設定ファイルの読み込みエラーなど、予期せぬ事態が発生した場合に、ユーザーに分かりやすいエラーメッセージを表示する。
* **インストール**: 各プラットフォーム向けのインストーラー（MSI, DMG, DEB/AppImageなど）を提供し、Python環境の有無を意識させずに利用開始できるようにする。

## 7. アーキテクチャ概要

1.  **Flutter (UI層)**: ユーザーからのイベント（ファイル選択、ボタンクリック等）を受け付け、画面を描画する。
2.  **連携 (I/O層)**:
    * ユーザーが「検出開始」をクリックすると、現在のGUI設定をJSON形式で一時ファイルに書き出す。
    * `pdf_presidio_processor.py` をサブプロセスとして起動し、入力PDFパスと設定JSONのパスを引数として渡す。
    * Pythonスクリプトは処理を行い、結果をJSON形式で標準出力または一時ファイルに出力する。
    * Flutterアプリは、そのJSON出力を受け取り、解析してUIに反映させる。
3.  **Python (バックエンド層)**: `pdf_presidio_processor.py` がPDFの解析、個人情報検出、レポート生成などの重い処理を担当する。GUIからの設定を読み込み、動作を制御する。

## 8. 開発マイルストーン案

1.  **フェーズ1: 基本機能の実装**
    * Flutterによる基本的なウィンドウと画面レイアウトの構築。
    * PDFファイルの読み込みと表示機能（PDFビューア）。
    * 「検出開始」ボタンを押すと、固定設定でPythonスクリプトを実行し、結果（JSON）をコンソールに出力する。
2.  **フェーズ2: コア機能の連携**
    * 検出結果を解析し、PDFビューア上にハイライトとして描画する。
    * 検出結果一覧パネルにリスト表示し、クリックでビューアと連動させる。
    * マスキング済みのPDFとして保存する機能。
3.  **フェーズ3: 設定とインタラクティブ機能**
    * 設定画面を実装し、各種設定（エンティティ、閾値など）をGUIから変更できるようにする。
    * 変更した設定が、Pythonスクリプトの実行に反映されるようにする。
    * アノテーションの追加・削除・修正機能を実装する。
4.  **フェーズ4: 仕上げとパッケージング**
    * レポート出力機能の実装。
    * エラーハンドリングの強化とUI/UXの改善。
    * 各プラットフォーム向けのインストーラーを作成し、配布可能な状態にする。

---